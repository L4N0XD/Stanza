<!DOCTYPE html>
{% load static %}
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Taylan Noronha">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link rel="icon" href="https://stanza.com.br/wp-content/uploads/2021/09/cropped-ms-icon-310x310-1-32x32.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js" integrity="sha384-zYPOMqeu1DAVkHiLqWBUTcbYfZ8osu1Nd6Z89ify25QV9guujx43ITvfi12/QExE" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.min.js" integrity="sha384-Y4oOpwW3duJdCWv5ly8SCFYWqFDsfob/3GkgExXKV4idmbt98QcxXYs9UoXAB7BZ" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding&display=swap" rel="stylesheet">    
    <title id="titulo">Gráfico de Resultados</title>
</head>
{% include "header.html" %}
<body class="bg-light">

<button style="display: none;" id="modalBtn" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#pageModal">
</button>

<div class="modal fade" id="pageModal" tabindex="-1" aria-labelledby="pageModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="pageModalLabel"></h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
       <p id="modalText">  </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
<section id="page" style="display: flex; flex-direction: column-reverse;">
  <div class="container col-md-2 shadow" style="position: absolute; top: 0; background: white; height: -webkit-fill-available;" id="divSidebar">

    <ul class="nav nav-pills flex-column mb-auto" style="margin-top: 30%;" id="ulSidebar">
      {% if filtro == True%}
        <li class="d-flex justify-content-center">
          <a href="/results-obras" class="btn btn-outline-stanza voltar-btn" style="font-size: 14px;border-radius: 50px;">Voltar</a>
        </li>
      {% endif %}
        <li>
            <form class="d-flex ms-auto" role="search" method="POST" action="{% url 'filtrar' %}" id="formulario">
                {% csrf_token %}
                <div class="input-group d-flex justify-content-center mt-2 align-items-center">
                    <button class="btn btn-secondary dropdown-toggle mb-3" style="width: 100%;border-radius: 7px;" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="button-filtrar">Filtrar por:</button>
                    <ul class="dropdown-menu dropdown-menu-secondary bg-secondary filtro-dropdown" style="border: gray solid 1px;">
                        <li><a class="dropdown-item filter" href="#" onclick="selecionarFiltro('mes_entrega')">Pedido Entregue</a></li>
                        <li><a class="dropdown-item filter" href="#" onclick="selecionarFiltro('mes_emissao_pc')">Solicitação de Compra</a></li>
                    </ul>
                    <input type="text" onfocus="(this.type='date')" onblur="(this.type='text')" id="data_inicial" name="data_inicial" class="form-control mb-2" placeholder="Data inicial" style="width: 100%; border-radius: 7px;">
                    <input type="text" onfocus="(this.type='date')" onblur="(this.type='text')" id="data_final" name="data_final" class="form-control mb-2" placeholder="Data final" style="width: 100%; border-radius: 7px;">
                    <input type="hidden" name="filtro" required id="id_filtro" onchange="atualizarGrafico()" value="">
                    <button id="filtrarBtn"class="btn btn-stanza" onclick="filtrar()" style="width: 100%; border-radius: 7px; margin-bottom: 100%;" type="submit">Filtrar</button>
                </div>
            </form>
        </li>
        <li class="mt-2">
          <hr style="margin-top: 20%;">
          <a href="/upload-page-obras" style="width: 100%;font-size: 16px; justify-content: center; margin-top: 20%;" class=" d-flex ms-auto btn btn-roxo mb-5" >Nova consulta</a>
        </li>  
    </ul>
  </div>

      <div class="container ">
        <h4 class="text-dark d-flex justify-content-center mt-3 mb-0">Obra: {{nome_obra}} </h4>
        <div class="d-flex justify-content-center mt-1">

            <p class="text-dark" style="width: 200px;" >Nº de Solicitacões: {{total_sols_compra}} </p>

            <p class="text-dark" style="width: 180px;">Total atendido: {{total_atendido}}</p>
        </div>  
        <button type="button" id="BotaoNoPrazo" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#NoPrazo" style="display: none;">
          Ver SC entregues no prazo
        </button>
        {% include "prazo.html" %}
        <button type="button" id="BotaoAtrasados" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#Atrasados" style="display: none;">
          Ver SC atrasadas
        </button>
        {% include "atrasados.html" %}
        <button type="button" id="BotaoIndeterminados" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#Indeterminados" style="display: none;">
          Ver SC Indeterminadas
        </button>
        {% include "indeterminados.html" %}
        <div id="barchart_values" style="width: 600px; height: 65%;" class="shadow d-flex justify-content-center align-items-center mt-0 mx-auto"></div>
      </div>
      {% if filtro == True %}
      <div style="position: absolute;right: 2%;top: 12.3%;">
        <button id="modalBtn" type="button" class="btn btn-stanza" href="#" role="button" data-bs-toggle="modal" data-bs-target="#detalhamento" style="font-size: 14px;border-radius: 50px;" >
          Detalhamento
        </button>
      </div>
        {% include "filtro.html" %}
        {% endif %}
</div>
  </section>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
{% include "footer.html" %}
{% block css %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% endblock %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <script>
(() => {
  'use strict'
  const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  tooltipTriggerList.forEach(tooltipTriggerEl => {
    new bootstrap.Tooltip(tooltipTriggerEl)
  })
})()

    const filtrarBtn = document.getElementById('filtrarBtn');
    const idFiltro = document.getElementById('id_filtro');
    const form = document.querySelector('#formulario');
    const modalBtn = document.querySelector('#modalBtn');
    const modalText = document.querySelector('#modalText');
    const modalTitle = document.querySelector('#pageModalLabel');
    form.addEventListener('submit', (event) => {
          if (idFiltro.value == "") {
            event.preventDefault();
            modalTitle.textContent = 'Erro'
            modalText.textContent = 'Por favor, selecione um filtro antes de enviar o formulário.'
            modalBtn.click();

      }
    });

  </script>
  <script>
    $(document).ready(function() {
      $('.filtro-dropdown a').click(function() {
        var selectedOption = $(this).text();
        $('#button-filtrar').text(selectedOption);
      });
    });

 

    </script>
  
  <script>
    var legenda = '{{legenda}}'
    var filtro = '{{filtro}}'
    var prazo_compra = parseInt('{{noprazo_compra}}');
    var atraso_compra = parseInt('{{atraso_compra}}');
    var ind_compra = parseInt('{{ind_compra}}');
    console.log(prazo_compra, atraso_compra, ind_compra);
    var prazo = parseInt('{{noprazo}}');
    var atraso = parseInt('{{atraso}}');
    var ind = parseInt('{{ind}}');
    console.log(ind, atraso, prazo);
    console.log(filtro.toLowerCase())

function selecionarFiltro(valor) {
  document.getElementById('id_filtro').value = valor;
  if (filtro.toLowerCase() !== 'true') {
    atualizarGrafico();
  }
}

function atualizarGrafico() {
  const idFiltro = document.getElementById('id_filtro');
  if (idFiltro.value === 'mes_entrega') {
   document.getElementById('atrasados').style.display = '';
   document.getElementById('atrasados-compra').style.display = 'none';
   document.getElementById('tabela-noPrazo').style.display = '';
   document.getElementById('tabela-noPrazo-compra').style.display = 'none';
   document.getElementById('tabela-Indeterminados').style.display = '';
   document.getElementById('tabela-Indeterminados-compra').style.display = 'none';
   drawChart(prazo, atraso, ind, 'Pedidos Entregues');
  } else if (idFiltro.value === 'mes_emissao_pc') {
    document.getElementById('tabela-noPrazo').style.display = 'none';
    document.getElementById('tabela-noPrazo-compra').style.display = '';
    document.getElementById('atrasados').style.display = 'none';
    document.getElementById('atrasados-compra').style.display = '';
    document.getElementById('tabela-Indeterminados').style.display = 'none';
    document.getElementById('tabela-Indeterminados-compra').style.display = '';
    drawChart(prazo_compra, atraso_compra, ind_compra, 'Solicitações de Compra');

  }
}

        google.charts.load("current", {packages:["corechart"]});
        if (legenda != '') {
          console.log(legenda)
          google.charts.setOnLoadCallback(function() { drawChart(prazo, atraso, ind, legenda); });
        } else {
          google.charts.setOnLoadCallback(function() { drawChart(prazo, atraso, ind, 'Pedidos Entregues'); });
        }


    function drawChart(prazo, atrasados, indeterminados, titulo) {
      var data = google.visualization.arrayToDataTable([
        ["Element", "Quantidade", { role: "style" } ],
        ["No Prazo", prazo, "green"],
        ["Atrasados", atrasados, "red"],
        ["Indeterminados", indeterminados, "gray"],
      ]);
      
      var view = new google.visualization.DataView(data);
      view.setColumns([0, 1,
      { calc: "stringify",
      sourceColumn: 1,
      type: "string",
      role: "annotation" },
      2]);
      
      var options = {
        title: titulo,
        width: 600,
        height: 400,
        bar: {groupWidth: "70%"},
        legend: { position: "none" },
      };
      var chart = new google.visualization.BarChart(document.getElementById("barchart_values"));
      google.visualization.events.addListener(chart, 'select', function() {
    var selectedItem = chart.getSelection()[0];
    if (selectedItem) {
    if (selectedItem.row == 0) {
      document.getElementById('BotaoNoPrazo').click(); 
    } else if (selectedItem.row == 1) {
      document.getElementById('BotaoAtrasados').click();
    } else if (selectedItem.row == 2) {
      document.getElementById('BotaoIndeterminados').click();
  }
}});
      chart.draw(view, options);
    }
    </script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
</body>
</body>
</html>